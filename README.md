# Файлы для сборки программ для использования в TVBuilder-M
Репозиторий содеержит среды для сборки программ на языке C под системы, представленные в программе TVBuilder-M:
* i8088-совместимый микропроцессор с двумя микросхемами памяти КР537РУ10
* Микроконтроллер с ядром на архитектуре RISC-V (RV32IMA_Zicsr)

Сборка программ осуществляется с помощью make. Кроме того приложен Dockerfile, содержащий все необходимые инструменты дляя сборки в интерактивном режиме. 

## Компиляция для i8088-совместимого процессора
Для сборки необходимо установить зависимости:
```
make gcc-ia16-elf
```

Тулчейн gcc отcутствует в стандартном репозитории apt, при использовании Ubuntu следует добавить репозиторий PPA или собрать из исходников. [Ссылка](https://github.com/tkchia/gcc-ia16) на репозиторий проекта на GitHub.

### Особенности программной среды C
* В связи с отсутствием какой-либо операционной системы ряд функций стандартной библиотеки работать не может
* Процессор начинает выполнение с адреса FFFF:0000. В приложенной библиотеке libtvb при статической линковке по этому адресу помещается трамплин на точку входа
* Точка входа в программу, на которую переходит трамплин - функция, помеченная `__attribute__((section(".entry")))`
* В силу отсутствия возможности динамической линковки библиотека подключается статически. Трамплин размещается по соответствующему адресу только в случае использования хотя бы одной функции из библиотеки. В библиотеку добавлена функция `init()` для использования в качеестве такой "заглушки".
* Предложенный Makefile собирает программу из расчета на наличие в схеме двух микросхем КР537РУ10, т.е. присутствует ограничение в 4 Кб на объем ОЗУ

### Таргеты Makefile
* Цель по умолчанию: сборка объектного файла и бинарных образов памяти микросхем (rom_0.bin и rom_1.bin для младшей и старшей микросхем соответственно)
* asm: генерация ассемблерного листинга программы с расширением .s
* clean: удаление объектных файлов и образов памяти

## Компиляция для RISC-V
Для сборки необходимо установить зависимости:
```
make gcc-riscv64-unknown-elf
```

Требуется версия gcc > 11.3. Если установленная версия слишком старая, требуется либо изменение Makefile, либо сборка из исходников, доступных в [репозитории GitHub](https://github.com/riscv-collab/riscv-gnu-toolchain).

### Особенности программной среды C
* В связи с отсутствием какой-либо операционной системы ряд функций стандартной библиотеки работать не может
* Система имеет 32 входа и 32 выхода, подключенных через Memory=mapped интерфейс. Адрес регистра входов `0x11500000`, адрес регистра выходов `0x11000000`
* Makefile по умолчанию требует имени исходного файла baremetal.c. Имя файла задается переменной PROJECT в файле

### Таргеты Makefile
* Цель по умолчанию all: сборка исполняемого файла .elf, образа памяти .bin; вывод objdump исполняемого файла в файл .debug.txt
* $PROJECT.elf, $PROJECT.bin, $PROJECT.debug.txt, где вместо $PROJECT следует подставить имя файла: сборка соответствующих файлов
* clean: удаление файлов $PROJECT.elf, $PROJECT.bin, $PROJECT.debug.txt, где вместо $PROJECT следует подставить имя файла

## Сборка с использованием Docker
В корне репозитория приведен Dockerfile, создающий контейнер, в котором установлены все необходимые для сборки пакеты.
Создание контейнера осуществляется командой, выполненной в той же директории, что и Dockerfile:
```
docker build -t "tvb-compilation:latest" .
```
Запуск контейнера в интерактивном режиме для сборки проекта на C:
```
docker run --mount type=bind,source="/path/to/c/source",target="/opt/tvb-compilation/" -it tvb-compilation /bin/bash
```
После выполнения команды в терминале будет активна сессия контейнера, в которой можно осуществлять сборку.
